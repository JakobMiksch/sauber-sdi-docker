<!doctype html>
<html lang="en">

<head>
    <title>UM / OL Demo</title>
    <style>
        body,
        html {
            width: 100%;
            height: 100%;
            margin: 0;
        }
        
        .map {
            height: 100%;
            width: 100%;
        }
    </style>

    <script src="./lib/ol/build/ol.js"></script>
    <script src="./lib/geotiff.js"></script>
    <script src="./lib/plotty.min.js"></script>
    <script src="./lib/um-js/nirvana.js"></script>

    <script type="text/javascript">
        let session = null;
        let channel = null;
        let url_array = [];

        window.onload = isLoaded;

        function isLoaded() {
            session = Nirvana.createSession({
                realms: ["http://localhost:9876"],
                // this can be an array of realms
                debugLevel: 4, // 1-9 (1 = noisy, 8 = severe, 9 = default = off)
                sessionTimeoutMs: 10000,
                enableDataStreams: false,
                drivers: [ // an array of transport drivers in preferred order:
                    Nirvana.Driver.WEBSOCKET,
                    Nirvana.Driver.XHR_STREAMING_CORS,
                    Nirvana.Driver.XDR_STREAMING,
                    Nirvana.Driver.JSONP_LONGPOLL,
                    Nirvana.Driver.XHR_LONGPOLL_CORS
                ]
            });

            function sessionStarted(s) {
                console.log("Session started with ID " + s.getSessionID());
                document.querySelector('#connected').innerHTML = 'Connected (Session ' + s.getSessionID() + ')'
            }
            session.on(Nirvana.Observe.START, sessionStarted);
            session.start();
            channel = session.getChannel("HeartbeatChannel");

            function myEventHandler(event) {
                let dictionary = event.getDictionary();
                document.querySelector('#outputTextarea').value += dictionary.get("timestamp") + ' | ' + dictionary.get("category") + ' | ' + dictionary.get("source") + ' | ' + dictionary.get("url") + '\n'
                url_array.push(dictionary.get("url"));
                let url = dictionary.get("url");

                // Nothing new until here

                // Check that timestamps make sense
                var date = new Date(parseInt(dictionary.get("timestamp")));
                var day = date.getDate();
                var month = date.getMonth();
                var year = date.getFullYear();
                var hours = date.getHours();
                var minutes = "0" + date.getMinutes();
                var seconds = "0" + date.getSeconds();
                var pingtime = day + ' ' + month + ' ' + year + ' ' + hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
                console.log(pingtime);
                // Can be removed  

                //Parser and plotter for incoming GeoTiffs 
                function onGeotiffLoaded(data) {
                    const tiff = GeoTIFF.parse(data);
                    const image = tiff.getImage();
                    const rawBox = image.getBoundingBox();
                    const box = [rawBox[0], rawBox[1] - (rawBox[3] - rawBox[1]), rawBox[2], rawBox[1]];
                    // Change bbox order to OL-compatible 
                    const bands = image.readRasters();
                    let canvas = document.createElement('canvas');
                    const minValue = 0;
                    const maxValue = 256;

                    const plot = new plotty.plot({
                        canvas: canvas,
                        data: bands[0],
                        width: image.getWidth(),
                        height: image.getHeight(),
                        domain: [minValue, maxValue],
                        colorScale: 'magma',
                        clampLow: true,
                        clampHigh: true
                    });

                    plot.render();

                    const tiff_source = new ol.source.ImageStatic({
                        url: canvas.toDataURL("image/png"),
                        imageExtent: box,
                        projection: 'EPSG:3857'
                    })
                    tiff_layer.setSource(tiff_source);
                    tiff_layer.setOpacity(0.5);
                };

                if (url.endsWith("e.tif")) {
                    try {
                        fetch(url).then(response => response.arrayBuffer()).then(onGeotiffLoaded);
                    } catch (err) {}
                };
            };

            channel.on(Nirvana.Observe.DATA, myEventHandler);
            channel.subscribe();
        };
    </script>
</head>

<body>
    <div id="map" class="map">
        <textarea id="outputTextarea" rows="2" cols="140"></textarea>
    </div>
    <script>
        const tiff_layer = new ol.layer.Image();
        const map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                }),
                tiff_layer
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([9.19, 48.784]),
                zoom: 13
            })
        });
    </script>
</body>

</html>